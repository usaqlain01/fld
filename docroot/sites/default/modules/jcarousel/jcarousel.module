<?php
// $Id$

/**
 * @file
 * Provides integration with 3rd party modules and the jCarousel library.
 */

/**
 * Implements hook_help().
 */
function jcarousel_help($path, $arg) {
  switch ($path) {
    case 'admin/help#carousel':
      $output = '<p>' . t('The following is a demonstration of Carousel module and its dependent library jCarousel.') . '</p>';

      // Construct the carousel list.
      $list = '<li><img src="http://static.flickr.com/66/199481236_dc98b5abb3_s.jpg" width="75" height="75" alt="" /></li>
        <li><img src="http://static.flickr.com/75/199481072_b4a0d09597_s.jpg" width="75" height="75" alt="" /></li>
        <li><img src="http://static.flickr.com/57/199481087_33ae73a8de_s.jpg" width="75" height="75" alt="" /></li>
        <li><img src="http://static.flickr.com/77/199481108_4359e6b971_s.jpg" width="75" height="75" alt="" /></li>
        <li><img src="http://static.flickr.com/58/199481143_3c148d9dd3_s.jpg" width="75" height="75" alt="" /></li>
        <li><img src="http://static.flickr.com/72/199481203_ad4cdcf109_s.jpg" width="75" height="75" alt="" /></li>
        <li><img src="http://static.flickr.com/58/199481218_264ce20da0_s.jpg" width="75" height="75" alt="" /></li>
        <li><img src="http://static.flickr.com/69/199481255_fdfe885f87_s.jpg" width="75" height="75" alt="" /></li>
        <li><img src="http://static.flickr.com/60/199480111_87d4cb3e38_s.jpg" width="75" height="75" alt="" /></li>
        <li><img src="http://static.flickr.com/70/229228324_08223b70fa_s.jpg" width="75" height="75" alt="" /></li>';

      // Provide the horizontal carousel demonstration.
      $output .= '<h3>Horizontal carousel</h3><ul class="horizontalcarousel jcarousel-skin-default">' . $list . '</ul>';
      carousel_add('horizontalcarousel');
      $output .= '<p>As you can see, simply calling <code>carousel_add()</code> with the element ID will create the default horizontal carousel.</p>';

      // Provide the vertical carousel demonstration.
      $output .= '<h3>Vertical carousel</h3><ul class="verticalcarousel jcarousel-skin-default">' . $list . '</ul>';
      carousel_add('verticalcarousel', array('vertical' => TRUE));
      $output .= '<p>The <a href="http://sorgalla.com/projects/jcarousel/#Configuration">configuration options</a> are passed via the second argument in the call to <code>carousel_add()</code>. In this example, we created a vertical carousel.</p>';

      // Provide the different skins carousel demonstration.
      $output .= '<h3>Different skins</h3><ul class="differentskin jcarousel-skin-tango">' . $list . '</ul>';
      carousel_add('differentskin', array('skin' => 'tango'));
      $output .= '<p>We can easily change the associated skin by changing the <code>$options[\'skin\']</code> property.</p>';

      // Another thing you can do is use the theme('carousel') function.
      $output .= '<h3>' . t('Theme function') . '</h3>';
      $items = array(
        '<img src="http://static.flickr.com/66/199481236_dc98b5abb3_s.jpg" width="75" height="75" alt="" />',
        '<img src="http://static.flickr.com/75/199481072_b4a0d09597_s.jpg" width="75" height="75" alt="" />',
        '<img src="http://static.flickr.com/57/199481087_33ae73a8de_s.jpg" width="75" height="75" alt="" />',
        '<img src="http://static.flickr.com/77/199481108_4359e6b971_s.jpg" width="75" height="75" alt="" />',
        '<img src="http://static.flickr.com/58/199481143_3c148d9dd3_s.jpg" width="75" height="75" alt="" />',
        '<img src="http://static.flickr.com/72/199481203_ad4cdcf109_s.jpg" width="75" height="75" alt="" />',
        '<img src="http://static.flickr.com/58/199481218_264ce20da0_s.jpg" width="75" height="75" alt="" />',
        '<img src="http://static.flickr.com/69/199481255_fdfe885f87_s.jpg" width="75" height="75" alt="" />',
        '<img src="http://static.flickr.com/60/199480111_87d4cb3e38_s.jpg" width="75" height="75" alt="" />',
        '<img src="http://static.flickr.com/70/229228324_08223b70fa_s.jpg" width="75" height="75" alt="" />',
      );
      $options = array(
        'buttonNextEvent' => 'mouseover',
        'buttonPrevEvent' => 'mouseover',
      );
      $output .= theme('carousel', $items, $options);
      $output .= '<p>' . t('The theme function allows you to easily create the markup, and add all the JavaScript to the page in one function call. In this example we create the carousel with the button next event being called when the mouse rolls over the buttons.') . '</p>';

      // Provide a circular wrap element.
      $output .= '<h3>' . t('Circular wrap') . '</h3>';
      $options = array(
        'wrap' => 'circular',
      );
      $output .= theme('jcarousel', $items, $options);
      return $output;
      break;
  }
}

/**
 * Implements hook_menu().
 */
function jcarousel_menu() {
  $items['jcarousel/ajax/views'] = array(
    'page callback' => 'jcarousel_views_ajax',
    'access callback' => TRUE,
    'file' => 'jcarousel.views.inc',
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implementation of hook_init().
 */
function jcarousel_init() {
  // Global JS settings required for all carousels.
  drupal_add_js(array('jcarousel' => array('ajaxPath' => url('jcarousel/ajax/views'))), 'setting');
}

/**
 * Implements hook_theme().
 */
function jcarousel_theme() {
  return array(
    'jcarousel' => array(
      'variables' => array('items' => NULL, 'options' => NULL, 'identifier' => NULL),
    ),
  );
}

/**
 * Implements hook_views_api().
 */
function jcarousel_views_api() {
  return array(
    'api' => 3.0,
  );
}

/**
 * Implements hook_jcarousel_skin_info().
 */
function jcarousel_jcarousel_skin_info() {
  $skins = array();

  $skins['default'] = array(
    'title' => t('Default'),
    'file' => 'skins/default/jcarousel-default.css',
  );
  $skins['tango'] = array(
    'title' => t('Tango'),
    'file' => 'skins/tango/jcarousel-tango.css',
  );

  return $skins;
}

/**
 * Adds all the necessary CSS and JS necessary for building a carousel.
 *
 * @param $settings
 *   A raw list of settings to be passed to jCarousel.
 * @param $identifier
 *   The unique ID that will be given to this carousel. Must be unique per page.
 *   If ommitted, a new ID will be generated automatically.
 * @return
 *   An array of JS and CSS files, suitable for inclusion as an #attached array.
 */
function jcarousel_add($identifier = NULL, $settings = array(), $add = TRUE) {
  static $unique_id, $library_added;

  // Give each carousel a unique ID if one isn't already provided.
  if (!isset($identifier)) {
    $unique_id = $unique_id ? $unique_id + 1 : 1;
    $identifier = 'carousel-id-' . $unique_id;
  }

  // Add the jCarousel library and any global settings.
  $attachments = array(
    // TODO: Change this to 'library' in Drupal 7.
    'js' => array(
      drupal_get_path('module', 'jcarousel') . '/js/jquery.jcarousel.js',
      drupal_get_path('module', 'jcarousel') . '/js/jcarousel.js',
    ),
  );

  // Set default options.
  $settings['selector'] = '.' . $identifier;
  $settings += array(
    'skin' => 'default',
  );

  // Allow other modules to modify these settings.
  drupal_alter('jcarousel_settings', $settings, $identifier);

  // Add settings for this individual carousel.
  if (!isset($library_added[$identifier])) {
    $library_added[$identifier] = TRUE;

    // Add the JavaScript settings for this Carousel.
    $js_settings = array(
      'jcarousel' => array(
        'carousels' => array(
          $identifier => $settings,
        ),
      ),
    );
    $attachments['js'][] = array(
      'type' => 'setting',
      'data' => $js_settings,
    );

    // Add the skin for this carousel.
    $skins = jcarousel_skins();
    $skin = isset($skins[$settings['skin']]) ? $skins[$settings['skin']] : $skins['default'];
    $attachments['css'][] = $skin['file path'] . '/' . $skin['file'];
  }

  // If adding directly to the page, loop through our attachments and add them.
  if ($add) {
    foreach ($attachments as $type => $type_list) {
      $drupal_add_type = 'drupal_add_' . $type;
      foreach ($type_list as $attachment) {
        if (is_array($attachment)) {
          $drupal_add_type($attachment['data'], $attachment['type']);
        }
        else {
          $drupal_add_type($attachment);
        }
      }
    }
  }

  return $attachments;
}

/**
 * Retrieves a list of all available Carousel skins.
 */
function jcarousel_skins() {
  static $skins;

  // Don't rebuild if we already have a list of skins.
  if (isset($skins)) {
    return $skins;
  }

  // Build a list of skins from other modules.
  $skins = array();
  foreach (module_implements('jcarousel_skin_info') as $module) {
    $function = $module . '_jcarousel_skin_info';
    $module_skins = $function();
    foreach ($module_skins as $key => $skin) {
      $skin['module'] = $module;
      $skin['file path'] = isset($skin['file path']) ? $skin['file path'] : drupal_get_path('module', $module);
      $skin['title'] = isset($skin['title']) ? $skin['title'] : $key;
      $skins[$key] = $skin;
    }
  }
  ksort($skins);
  return $skins;
}

/**
 * Creates a carousel element on the page.
 * 
 * @param $items
 *   The items to appear in the carousel.
 * @param $options
 *   The arguments to apply to the selected element when creating the jCarousel.
 *   The arguments are passed through as an associative array using the
 *   jCarousel configuration options:
 *   http://sorgalla.com/projects/jcarousel/#Configuration
 * @param $id
 *   A unique ID for this carousel. If not provided, one will be generated
 *   automatically.
 */

function theme_jcarousel(array $variables = array()) {
  $items = $variables['items'] ? $variables['items'] : array();
  $options = $variables['options'] ? $variables['options'] : array();
  $identifier = $variables['identifier'] ? $variables['identifier'] : NULL;
  static $unique;
  if (!isset($identifier)) {
    $unique = isset($unique) ? $unique + 1 : 1;
    $identifier = 'jcarousel-id-' . $unique;
  }

  $options['skin'] = array_key_exists('skin', $options) ? $options['skin'] : 'default';
  carousel_add($identifier, $options);

  $classes = 'jcarousel ' . $identifier;
  if (!empty($options['skin'])) {
    $classes .= ' jcarousel-skin-' . $options['skin'];
  }

  $output = '<ul class="' . $classes . '">';
  foreach ($items as $item) {
    $output .= '<li>'. $item .'</li>';
  }
  $output .= '</ul>';
  return $output;
}

/**
 * Implements hook_library().
 */
function jcarousel_library() {
  $libraries = array();

  $libraries['jcarousel'] = array(
    'title' => 'jCarousel',
    'website' => 'http://sorgalla.com/jcarousel/',
    'version' => '0.2.7',
    'js' => array(
      drupal_get_path('module', 'jcarousel') . '/js/jquery.jcarousel.min.js' => array('group' => JS_LIBRARY),
    ),
  );

  return $libraries;
}
